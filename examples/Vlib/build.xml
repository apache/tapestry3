<?xml version="1.0"?>
<!-- $Id$ -->
<project name="Virtual Library Demo" default="install">

  <!-- Directory in which compiled classes are placed -->
  <property name="classes" value="classes"/>

  <!-- Directory that contains library frameworks, and to
       which the WAR is eventually installed -->
  <property name="lib" value="../../lib"/>

  <!-- Directory containing source code and package resources -->
  <property name="src" value="src"/>

  <!-- Path of the installed framework jar -->
  <property name="vlib.war" value="${lib}/Vlib.war"/>

  <!-- Need the jboss.dir property -->
  
  <property file="../../config/build.properties"/>

  <path id="project.class.path">
    <pathelement location="${lib}/ejb.jar"/>
    <pathelement location="${lib}/javax.servlet.jar"/>
    <pathelement location="${lib}/log4j-core.jar"/>
    <pathelement location="${lib}/javax.xml.jaxp.jar"/>
    <pathelement location="${lib}/org.apache.crimson.jar"/>
    <pathelement location="${lib}/com.primix.tapestry.jar"/>
    <pathelement location="${lib}/net.sf.tapestry.contrib.jar"/>
    <pathelement location="${lib}/VlibBeans.jar"/>
  </path>

  <target name="init">
    <tstamp/>
    <mkdir dir="${classes}"/>
  </target>

  <target name="clean">
    <delete dir="${classes}"/>
  </target>

  <target name="compile" depends="init" description="Compile all classes in the framework.">
    <javac srcdir="${src}" destdir="${classes}">
      <classpath refid="project.class.path"/>
    </javac>
  </target>
    
  <target name="install" depends="compile" description="Compile all classes and build the installed WAR including all package resources.">
    <copy todir="${classes}">
            <fileset dir="${src}">
        <include name="**/*.jwc"/>
        <include name="**/*.html"/>
        <include name="**/*.gif"/>
        <include name="**/*.dtd"/>
        <include name="**/*.script"/>
        <include name="**/*.properties"/>
        <include name="**/*.application"/>
        <exclude name="**/package.html"/>
      </fileset>
    </copy>
    <war warfile="${vlib.war}" webxml="web.xml">

      <fileset dir=".">
        <include name="*.html"/>
        <include name="images/**"/>
        <include name="scripts/**"/>
     </fileset>
	  <classes dir="${classes}"/>         
    </war>
  </target>

  <target name="run" description="Run the Vlib application." depends="install">
    <java classname="org.mortbay.jetty.Server" fork="true">
      <classpath>

      	<!-- Favor files in src over copies in classes -->
      	<pathelement location="${src}"/>
      	
      	<!-- Temporary hack: pick up compiled files from Eclipse's compilation directory
      	     instead of our own: necessary for debugging.  -->
      	     
        <pathelement location="../../bin"/>

        <pathelement location="${lib}/org.mortbay.jetty.jar"/>
        <!-- Runtime client libraries -->
        <pathelement location="${jboss.dir}/client/jboss-client.jar"/>
        <pathelement location="${jboss.dir}/client/jbosssx-client.jar"/>
        <pathelement location="${jboss.dir}/client/jnp-client.jar"/>
        
         <path refid="project.class.path"/>

      </classpath>

      <arg value="jetty.xml"/>

      <sysproperty key="com.primix.tapestry.enable-reset-service" value="true"/>
      <sysproperty key="com.primix.vlib.debug-enabled" value="true"/>
      
      <!-- Enable debugging on port 20150 --> 
       
      <jvmarg line="-showversion -Xdebug -Xnoagent"/>
      <jvmarg line="-Xrunjdwp:transport=dt_socket,suspend=n,server=y,address=20150"/>
      <sysproperty key="java.compiler" value="NONE"/>     
       
      <sysproperty key="com.primix.tapestry.disable-caching" value="true"/>
      <sysproperty key="com.primix.tapestry.enable-reset-service" value="true"/>

      <!-- JNDI Configuration for JBoss -->
      
      <sysproperty key="java.naming.factory.initial" value="org.jnp.interfaces.NamingContextFactory"/>
      <sysproperty key="java.naming.factory.url.pkgs" value="org.jboss.naming:org.jnp.interfaces"/>
      <sysproperty key="java.naming.provider.url" value="localhost:1099"/>
      
   </java>
  </target>

</project>


<?xml version="1.0"?>
<!-- $Id$ -->
<project name="Tapestry VlibBeans Example" default="install">
  <!-- Directory in which compiled classes are placed -->
  <property name="classes" value="classes"/>
  <!-- Directory that contains library frameworks, and to
       which the framework is eventually installed -->
  <property name="lib" value="../../lib"/>
  <!-- Directory containing source code and package resources -->
  <property name="src" value="src"/>
  <!-- Path of the installed framework jar -->
  <property name="VlibBeans.jar" value="${lib}/VlibBeans.jar"/>

  <!-- Read the configuration file to get the absolute path
       to the JBoss installation (2.4.x). -->
       
  <property file="../../config/build.properties"/>
  
  <path id="project.class.path">
    <pathelement location="${lib}/javax.servlet.jar"/>
    <pathelement location="${lib}/log4j-core.jar"/>
    <pathelement location="${lib}/javax.xml.jaxp.jar"/>
    <pathelement location="${lib}/org.apache.crimson.jar"/>
    <pathelement location="${lib}/com.primix.tapestry.jar"/>
    <pathelement location="${jboss.dir}/lib/jboss-jdbc_ext.jar"/>
    <pathelement location="${jboss.dir}/lib/ext/mail.jar"/>
    <pathelement location="${jboss.dir}/lib/ext/activation.jar"/>
    <pathelement location="${jboss.dir}/lib/ext/jboss-j2ee.jar"/>
  </path>
  
  <target name="init">
    <tstamp/>
    <mkdir dir="${classes}"/>
  </target>
  
  <target name="clean">
    <delete dir="${classes}"/>
  </target>
  
  <target name="compile" depends="init" description="Compile all classes in the JAR.">
    <javac srcdir="${src}" destdir="${classes}">
      <classpath refid="project.class.path"/>
    </javac>
  </target>
  
  <!-- No particular need to use the ejbjar task here, this project isolates all the
       VlibBeans related code into one place, so there's no need to "reconstruct" what's
       needed from the deployment descriptors. -->
  
  <target name="install" depends="compile" description="Compile all classes and build the installed JAR including all package resources.">
    <jar jarfile="${VlibBeans.jar}">
      <fileset dir="${classes}"/>
      <metainf dir=".">
        <include name="*.xml"/>
        <exclude name="build.xml"/>
      </metainf>
    </jar>
  </target>

  <target name="configure" description="Configure the JBoss server and setup the Vlib database.">
    <copy todir="${jboss.dir}/conf/default" overwrite="true">
      <fileset dir="jboss">
      	<include name="*.properties"/>
      </fileset>
    </copy>
    <copy todir="${jboss.dir}/lib/ext" file="${lib}/com.primix.tapestry.jar"/>
    <untar src="jboss/vlib.tar" dest="${jboss.dir}/db"/>
    <echo>
You must manually edit ${jboss.dir}/conf/default/jboss.jcml.
The file jboss/jboss.jcml.splice should be inserted at the end
of the file.
    </echo>
  </target>

  <target name="run" description="Deploy the JAR file and run the Jboss server." depends="install">
    <copy file="${lib}/VlibBeans.jar" todir="${jboss.dir}/deploy"/>
    <java dir="${jboss.dir}/bin" classname="org.jboss.Main" fork="true">
      <classpath>
         <pathelement location="${jboss.dir}/bin/run.jar"/>
         <pathelement location="${jboss.dir}/lib/crimson.jar"/>
      </classpath>
      <sysproperty key="javax.xml.parsers.DocumentBuilderFactory" value="org.apache.crimson.jaxp.DocumentBuilderFactoryImpl"/>
      <sysproperty key="javax.xml.parsers.SAXParserFactory" value="org.apache.crimson.jaxp.SAXParserFactoryImpl"/>
    </java>
  </target>
  
</project>


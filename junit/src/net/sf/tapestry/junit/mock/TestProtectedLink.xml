<?xml version="1.0" encoding="UTF-8"?>

<!-- $Id$ -->


<!-- Tests DirectCallback -->

<mock-test>
    <context name="mock"/>
  	
    <servlet name="app" class="net.sf.tapestry.ApplicationServlet">
  		<init-parameter
  			name="net.sf.tapestry.application-specification"
  			value="/net/sf/tapestry/junit/mock/app/Mock.application"/>
  	</servlet>
  		
  	<!--  Get a view of the page -->
  	
	<request>
  		<parameter name="service" value="page"/>
  		<parameter name="context" value="ProtectedLink"/>
  		
  		<assert-output name="Title">
<![CDATA[
<title>ProtectedLink</title>
]]>
		</assert-output>
		
		<assert-output name="Link URL">
<![CDATA[
href="/mock/app?service=direct&amp;context=0/ProtectedLink/link&amp;sp=6&amp;sp=13&amp;sp=1999"
]]>
		</assert-output>
  		
	</request>
	
	<request>
		<parameter name="service" value="direct"/>
		<parameter name="context" value="0/ProtectedLink/link"/>
		<parameter name="sp">
			<value>6</value>
			<value>13</value>
			<value>1999</value>
		</parameter>  		
  		
  		<assert-output name="Title">
<![CDATA[
<title>Guard</title>
]]>
		</assert-output>
		
		<assert-output name="Link URL">
<![CDATA[
href="/mock/app?service=direct&amp;context=1/Guard/link"
]]>
		</assert-output>
		
		<assert-output name="Callback">
<![CDATA[
Callback: DirectCallback[ProtectedLink/link 6, 13, 1999]
]]>		
		</assert-output>		
  	</request>
  	
  	<!-- Simulate clicking the Guard page link, which should send the
  	     user to the Protected page.  -->
  	     
  	<request>
  		<parameter name="service" value="direct"/>
  		<parameter name="context" value="1/Guard/link"/>
  		
  		<assert-output name="Title">
<![CDATA[
<title>ProtectedLink: Result</title>
]]>
		</assert-output>
		
		<assert-output-matches name="Parameters" subgroup="1">
<![CDATA[
<li>(.*?)</li>
]]>
			<match>6</match>
			<match>13</match>
			<match>1999</match>
		</assert-output-matches>

	</request>
		  	
	<!-- Go back and click the original link now that the Guard
	 	 page has been visited. -->		  	
		  	
  	<request>
		<parameter name="service" value="direct"/>
		<parameter name="context" value="1/ProtectedLink/link"/>
		<parameter name="sp">
			<value>6</value>
			<value>13</value>
			<value>1999</value>
		</parameter>  
		  		
  		<assert-output name="Title">
<![CDATA[
<title>ProtectedLink: Result</title>
]]>
		</assert-output>
		
		<assert-output-matches name="Parameters" subgroup="1">
<![CDATA[
<li>(.*?)</li>
]]>
			<match>6</match>
			<match>13</match>
			<match>1999</match>
		</assert-output-matches>

	</request>		  	
</mock-test>